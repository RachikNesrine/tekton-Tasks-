apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: select-environment
spec:
  params:
    - name: branch
      type: string

  results:
    - name: environment
      type: string

  steps:
    - name: select
      image: alpine:3.19
      script: |
        #!/bin/sh
        set -e

        BRANCH="$(params.branch)"
        ENVIRONMENT="dev"

        if echo "$BRANCH" | grep -Eq '^(release|hotfix)'; then
          ENVIRONMENT="stg"
        elif echo "$BRANCH" | grep -Eq '^(main|master)'; then
          ENVIRONMENT="prd"
        fi

        echo "$ENVIRONMENT" > "$(results.environment.path)"
